<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Orbit‚ÄëRunner</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="welcome-screen" class="welcome-layout">
      <!-- Header Section -->
      <div class="welcome-header">
        <div class="game-logo">
          <div class="logo-icon"></div>
          <div class="logo-text">
            <h1 class="game-title">Orbit Runner</h1>
            <p class="game-subtitle">Multiplayer Space Combat</p>
          </div>
        </div>
        <p class="game-description">
          Connect your Demos wallet to join other pilots in real-time 3D space
          combat! Break the current high score to win the jackpot. Pay 1 DEM to play.
        </p>
      </div>

      <!-- Main Content Grid -->
      <div class="welcome-content">
        <!-- Wallet Section -->
        <div class="wallet-section">
          <h3 class="section-title">Wallet Connection</h3>
          
          <div class="connection-status" id="extension-status">
            <div class="status-indicator checking" id="extension-indicator"></div>
            <span id="extension-status-text">Checking for Demos extension...</span>
          </div>

          <button id="connect-extension-btn" class="primary-btn" disabled>
            Connect Demos Extension
          </button>

          <div class="wallet-warning" id="extension-warning" style="display: none">
            Demos extension not detected. Please install the extension or use another connection method.
          </div>

          <div id="connected-wallet" class="connected-wallet" style="display: none">
            <div class="wallet-info">
              <div class="connection-status connected">
                <div class="status-indicator connected"></div>
                <span>Connected</span>
              </div>
              <div class="wallet-address" id="connected-address">Not connected</div>
              <div class="wallet-balance" id="connected-balance">Balance: 0 DEMOS</div>
            </div>
            <button id="disconnect-btn" class="disconnect-btn">Disconnect</button>
          </div>

          <div class="extension-help">
            <p><strong>Don't have the Demos extension?</strong></p>
            <p>Install the Demos browser extension for seamless wallet connectivity.</p>
            <a href="https://chromewebstore.google.com/detail/demos-wallet/nefongcpmdahjaijjkihgieiamoahcoo?pli=1" 
               target="_blank" class="help-link">Download Demos Extension</a>
          </div>
        </div>

        <!-- Game Controls Section -->
        <div class="controls-section">
          <h3 class="section-title">Launch Game</h3>
          
          <button id="launch-btn" class="launch-btn" disabled>
            <span>Launch Into Space</span>
          </button>
          
          <!-- Demo Mode Button for Testing -->
          <div class="demo-mode-section">
            <button id="demo-mode-btn" class="demo-btn">
              üéÆ Demo Mode (Test Multiplayer)
            </button>
            <p class="demo-description">Skip wallet connection for testing multiplayer sync</p>
          </div>
        </div>

        <!-- How to Play Section -->
        <div class="help-section">
          <h3 class="section-title">Game Guide</h3>
          
          <button id="how-to-play-btn" class="secondary-btn">
            How to Play
          </button>
        </div>
      </div>

      <!-- Blockchain Test Section (hidden from view but functional) -->
      <div class="blockchain-test-section" style="display: none;">
        <button id="test-blockchain-btn" class="secondary-btn" disabled>
          Test Blockchain Connection
        </button>
        <div id="blockchain-test-results" class="blockchain-test-results" style="display: none"></div>
      </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <!-- Testnet Notice Banner -->
    <div id="testnet-banner" class="testnet-banner">
      <div class="testnet-content">
        <div class="testnet-icon">‚ö†Ô∏è</div>
        <div>
          <h3 class="testnet-title">Testnet Mode</h3>
          <p class="testnet-text">This app uses testnet DEM tokens. No asteroid was hurt during the creation of this game.</p>
        </div>
        <button id="testnet-close" class="testnet-close">
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="testnet-progress"></div>
    </div>

    <!-- Footer -->
    <footer class="demos-footer">
      <div class="footer-content">
        <a href="https://demos.sh" target="_blank" rel="noopener noreferrer" class="footer-link">
          Made with Demos SDK
        </a>
      </div>
    </footer>

    <script>
      // Testnet banner functionality
      document.addEventListener('DOMContentLoaded', function() {
        const banner = document.getElementById('testnet-banner');
        const closeBtn = document.getElementById('testnet-close');
        
        if (banner && closeBtn) {
          // Auto-dismiss after 20 seconds
          const autoDismissTimer = setTimeout(() => {
            dismissBanner();
          }, 20000);
          
          // Close button functionality
          closeBtn.addEventListener('click', () => {
            clearTimeout(autoDismissTimer);
            dismissBanner();
          });
          
          // Dismiss on scroll
          const handleScroll = () => {
            clearTimeout(autoDismissTimer);
            dismissBanner();
            window.removeEventListener('scroll', handleScroll);
          };
          window.addEventListener('scroll', handleScroll);
          
          function dismissBanner() {
            banner.classList.add('dismissing');
            setTimeout(() => {
              banner.style.display = 'none';
            }, 300);
          }
        }
      });
    </script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.164.0/build/three.module.min.js"
        }
      }
    </script>

    <!-- Load Three.js ESM directly from node_modules, then start the game -->
    <script type="module">
      // Point client to Railway API in production; keep localhost auto-detect for local dev
      if (!location.hostname.match(/^(localhost|127\.0\.0\.1)/)) {
        window.ORBIT_RUNNER_API =
          "https://orbit-runner-production.up.railway.app";
      }
      import * as THREE from "https://unpkg.com/three@0.164.0/build/three.module.min.js";
      window.THREE = THREE;
    </script>

    <!-- Demos Extension Detector (must load before main.js) -->
    <script src="demos-extension-detector.js"></script>

    <script type="module">
      // Cache-bust main.js so changes always load on refresh during development
      await import(`./main.js?cb=${Date.now()}`);
    </script>
  </body>
</html>
